{% extends "base.html" %}

{% block title %}AI Chat - Cybersecurity Agent{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-white mb-4"><i class="bi bi-robot"></i> AI Security Assistant</h1>
    <p class="text-white-50">UC-ADM-04: ‡∏ñ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏±‡∏ö AI ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå</p>

    <div class="row">
        <div class="col-md-8">
            <div class="card" style="height: 600px; display: flex; flex-direction: column;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Chat</h5>
                    <div>
                        <span class="badge bg-success" id="ai-status">
                            <i class="bi bi-circle-fill"></i> <span id="model-name">Loading...</span>
                        </span>
                    </div>
                </div>
                <div class="card-body" style="flex: 1; overflow-y: auto; background: #f8f9fa;" id="chat-messages">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
                        <p class="mt-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö AI Security Assistant</p>
                        <small>‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå</small>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" class="form-control" id="user-message" 
                                   placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." autocomplete="off" required>
                            <button type="submit" class="btn btn-primary" id="send-btn">
                                <i class="bi bi-send"></i> ‡∏™‡πà‡∏á
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-gear"></i> Settings</h6>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="use-rag" checked>
                        <label class="form-check-label" for="use-rag">
                            <i class="bi bi-database"></i> Enable RAG
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="use-exploitdb">
                        <label class="form-check-label" for="use-exploitdb">
                            <i class="bi bi-book"></i> Use Exploit-DB Papers
                            <span class="badge bg-success">NEW</span>
                        </label>
                        <small class="text-muted d-block">Search from 1,600+ security papers</small>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> AI Model Info</h6>
                </div>
                <div class="card-body">
                    <p><strong>Model:</strong> <span id="info-model">-</span></p>
                    <p><strong>Provider:</strong> <span id="info-provider">-</span></p>
                    <p><strong>Type:</strong> <span id="info-type">-</span></p>
                    <p><strong>Status:</strong> <span id="info-status" class="badge bg-success">Active</span></p>
                    <hr>
                    <p><strong>RAG:</strong> <span id="info-rag" class="badge bg-info">Enabled</span></p>
                    <p><strong>Vector Store:</strong> <span id="info-vector">-</span></p>
                    <p><strong>Documents:</strong> <span id="info-docs">0</span></p>
                    <p class="mb-0"><strong>Chunks:</strong> <span id="info-chunks">0</span></p>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm text-start sample-question">
                            <i class="bi bi-question-circle"></i> What is SQL injection?
                        </button>
                        <button class="btn btn-outline-primary btn-sm text-start sample-question">
                            <i class="bi bi-question-circle"></i> Explain buffer overflow exploitation
                        </button>
                        <button class="btn btn-outline-primary btn-sm text-start sample-question">
                            <i class="bi bi-question-circle"></i> How does XSS attack work?
                        </button>
                        <button class="btn btn-outline-primary btn-sm text-start sample-question">
                            <i class="bi bi-question-circle"></i> What are J2EE vulnerabilities?
                        </button>
                        <button class="btn btn-outline-primary btn-sm text-start sample-question">
                            <i class="bi bi-question-circle"></i> Explain privilege escalation techniques
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-shield-check"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-warning btn-sm w-100 mb-2" id="analyze-logs-btn">
                        <i class="bi bi-search"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </button>
                    <button class="btn btn-info btn-sm w-100" id="clear-chat-btn">
                        <i class="bi bi-trash"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let chatHistory = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI Model ‡πÅ‡∏•‡∏∞ Vector Store
    fetch('/api/ai-info')
        .then(res => res.json())
        .then(info => {
            document.getElementById('model-name').textContent = info.model || 'Unknown';
            document.getElementById('info-model').textContent = info.model || '-';
            document.getElementById('info-provider').textContent = info.provider || '-';
            document.getElementById('info-type').textContent = info.type || '-';
            
            if (info.status === 'active') {
                document.getElementById('info-status').className = 'badge bg-success';
                document.getElementById('info-status').textContent = 'Active';
            } else {
                document.getElementById('info-status').className = 'badge bg-danger';
                document.getElementById('info-status').textContent = 'Inactive';
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RAG
            if (info.rag_enabled) {
                document.getElementById('info-rag').className = 'badge bg-success';
                document.getElementById('info-rag').textContent = 'Enabled';
                document.getElementById('info-vector').textContent = info.vector_store || '-';
                document.getElementById('info-docs').textContent = info.total_documents || 0;
                document.getElementById('info-chunks').textContent = info.total_chunks || 0;
            } else {
                document.getElementById('info-rag').className = 'badge bg-warning';
                document.getElementById('info-rag').textContent = 'Disabled';
            }
        })
        .catch(err => {
            console.error('Failed to load AI info:', err);
            document.getElementById('ai-status').className = 'badge bg-danger';
            document.getElementById('model-name').textContent = 'Error';
        });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô chat
    function addMessage(message, isUser = false) {
        const chatMessages = document.getElementById('chat-messages');
        
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (chatHistory.length === 0) {
            chatMessages.innerHTML = '';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${isUser ? 'text-end' : ''}`;
        
        const bubble = document.createElement('div');
        bubble.className = `d-inline-block p-3 rounded ${isUser ? 'bg-primary text-white' : 'bg-white border'}`;
        bubble.style.maxWidth = '80%';
        bubble.style.textAlign = 'left';
        
        // ‡πÅ‡∏õ‡∏•‡∏á markdown-style formatting
        let formattedMessage = message
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
        
        bubble.innerHTML = `
            <div class="mb-1">
                <small class="text-muted">
                    <i class="bi bi-${isUser ? 'person' : 'robot'}"></i>
                    ${isUser ? 'You' : 'AI Assistant'}
                </small>
            </div>
            <div>${formattedMessage}</div>
            <div class="mt-1">
                <small class="text-muted">${new Date().toLocaleTimeString('th-TH')}</small>
            </div>
        `;
        
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        chatHistory.push({ message, isUser, timestamp: new Date() });
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    document.getElementById('chat-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const input = document.getElementById('user-message');
        const message = input.value.trim();
        
        if (!message) return;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        addMessage(message, true);
        input.value = '';
        
        // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á
        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...';
        
        try {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ settings
            const useRag = document.getElementById('use-rag').checked;
            const useExploitdb = document.getElementById('use-exploitdb').checked;
            
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á API
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message,
                    use_rag: useRag,
                    use_exploitdb: useExploitdb
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                addMessage(data.response, false);
                
                // ‡πÅ‡∏™‡∏î‡∏á badge ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Exploit-DB
                if (data.exploitdb_enabled) {
                    const chatMessages = document.getElementById('chat-messages');
                    const lastMessage = chatMessages.lastElementChild;
                    const badge = '<span class="badge bg-success ms-2"><i class="bi bi-book"></i> Exploit-DB</span>';
                    lastMessage.querySelector('.d-inline-block').insertAdjacentHTML('afterbegin', badge);
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á sources ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (data.sources && data.sources.length > 0) {
                    let sourcesHtml = '<div class="mt-2 p-2 bg-light border rounded"><small><strong>üìö Sources:</strong><br>';
                    data.sources.forEach((source, i) => {
                        const title = source.title || source.filename || 'Unknown';
                        const score = source.relevance_score || source.score || 0;
                        sourcesHtml += `${i+1}. ${title} (Score: ${(score * 100).toFixed(0)}%)<br>`;
                    });
                    sourcesHtml += '</small></div>';
                    
                    const chatMessages = document.getElementById('chat-messages');
                    const lastMessage = chatMessages.lastElementChild;
                    lastMessage.querySelector('.d-inline-block').insertAdjacentHTML('beforeend', sourcesHtml);
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ RAG
                if (data.context_used) {
                    console.log('‚úÖ RAG was used for this response');
                }
            } else {
                addMessage('‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || 'Unknown error'), false);
            }
        } catch (error) {
            addMessage('‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI ‡πÑ‡∏î‡πâ: ' + error.message, false);
        } finally {
            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="bi bi-send"></i> ‡∏™‡πà‡∏á';
            input.focus();
        }
    });

    // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    document.querySelectorAll('.sample-question').forEach(btn => {
        btn.addEventListener('click', function() {
            const question = this.textContent.trim().replace('?', '').trim();
            document.getElementById('user-message').value = question;
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        });
    });

    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Logs
    document.getElementById('analyze-logs-btn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
        
        try {
            // ‡∏î‡∏∂‡∏á logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const logsResponse = await fetch('/api/logs?limit=10');
            const logs = await logsResponse.json();
            
            if (logs.length === 0) {
                addMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö Logs ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', false);
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            const criticalLogs = logs.filter(log => log.severity === 'CRITICAL');
            const message = `Analyze these recent security logs: ${criticalLogs.length} critical events found. What should I be concerned about?`;
            
            document.getElementById('user-message').value = message;
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        } catch (error) {
            addMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Logs', false);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
        }
    });

    // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    document.getElementById('clear-chat-btn').addEventListener('click', function() {
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            chatHistory = [];
            document.getElementById('chat-messages').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
                    <p class="mt-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö AI Security Assistant</p>
                    <small>‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå</small>
                </div>
            `;
        }
    });

    // Focus input on load
    document.getElementById('user-message').focus();
</script>
{% endblock %}
