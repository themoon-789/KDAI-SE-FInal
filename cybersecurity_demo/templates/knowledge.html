{% extends "base.html" %}

{% block title %}Knowledge Base - Cybersecurity Agent{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-white mb-4"><i class="bi bi-book"></i> Knowledge Base Management</h1>
    <p class="text-white-50">UC-ADM-01: นำเข้าและจัดการเอกสารองค์ความรู้</p>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-upload"></i> นำเข้าเอกสาร</h5>
                </div>
                <div class="card-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">เลือกไฟล์เอกสาร</label>
                            <input type="file" class="form-control" id="file-input" accept=".pdf,.docx" required>
                            <small class="text-muted">รองรับ: PDF, DOCX</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-cloud-upload"></i> อัปโหลดเอกสาร
                        </button>
                    </form>

                    <div id="upload-status" class="mt-3"></div>

                    <hr>

                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> กระบวนการ</h6>
                        <ol class="mb-0 small">
                            <li>อัปโหลดไฟล์</li>
                            <li>ระบบแปลงเป็น Vector Embedding</li>
                            <li>จัดเก็บใน Vector Database</li>
                            <li>พร้อมใช้งานทันที</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-folder"></i> เอกสารที่นำเข้า</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ชื่อไฟล์</th>
                                    <th>วันที่อัปโหลด</th>
                                    <th>ขนาด</th>
                                    <th>สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="documents-table">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="bi bi-inbox"></i> ยังไม่มีเอกสาร
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> สถิติ Knowledge Base</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3 class="text-primary" id="total-docs">0</h3>
                            <p class="text-muted">เอกสารทั้งหมด</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-success" id="total-vectors">0</h3>
                            <p class="text-muted">Vector Embeddings</p>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-info" id="db-size">0 MB</h3>
                            <p class="text-muted">ขนาด Database</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // โหลดรายการเอกสาร
    function loadDocuments() {
        fetch('/api/documents')
            .then(res => res.json())
            .then(documents => {
                const tbody = document.getElementById('documents-table');
                
                if (documents.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <i class="bi bi-inbox"></i> ยังไม่มีเอกสาร
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = documents.map(doc => `
                    <tr>
                        <td>${doc.id}</td>
                        <td><i class="bi bi-file-earmark-pdf"></i> ${doc.filename}</td>
                        <td>${doc.upload_time}</td>
                        <td>${(doc.size / 1024).toFixed(2)} KB</td>
                        <td><span class="badge bg-success">${doc.status}</span></td>
                    </tr>
                `).join('');

                // อัปเดตสถิติ
                document.getElementById('total-docs').textContent = documents.length;
                document.getElementById('total-vectors').textContent = documents.length * 128; // จำลอง
                const totalSize = documents.reduce((sum, doc) => sum + doc.size, 0);
                document.getElementById('db-size').textContent = (totalSize / (1024 * 1024)).toFixed(2) + ' MB';
            });
    }

    // อัปโหลดเอกสาร
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('กรุณาเลือกไฟล์');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        const statusDiv = document.getElementById('upload-status');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-hourglass-split"></i> กำลังอัปโหลดและประมวลผล...
            </div>
        `;

        fetch('/api/upload-document', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> ${data.message}
                    </div>
                `;
                fileInput.value = '';
                loadDocuments();
                
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> เกิดข้อผิดพลาด: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> เกิดข้อผิดพลาด: ${error.message}
                </div>
            `;
        });
    });

    // โหลดข้อมูลเริ่มต้น
    loadDocuments();
</script>
{% endblock %}
